{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block page_title %}Message de {{ message.nom_prenom }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'admin_messages_list' %}">Messages</a>
                </li>
                <li class="breadcrumb-item active">{{ message.nom_prenom }}</li>
            </ol>
        </nav>
        <h2>
            <i class="fas fa-envelope me-2"></i>
            Message de {{ message.nom_prenom }}
        </h2>
    </div>
    <div>
        {% if not message.is_replied %}
            <a href="{% url 'admin_mark_message_replied' message.pk %}" 
               class="btn btn-success me-2"
               onclick="return confirm('Marquer ce message comme répondu ?')">
                <i class="fas fa-check me-1"></i>
                Marquer comme répondu
            </a>
        {% endif %}
        <a href="mailto:{{ message.email }}?subject=Re: {{ message.sujet }}" 
           class="btn btn-primary">
            <i class="fas fa-envelope me-1"></i>
            Répondre par email
        </a>
        {% if message.telephone %}
            <a href="https://wa.me/{{ message.telephone|cut:' '|cut:'+'|cut:'-' }}?text=Bonjour {{ message.nom_prenom }}, nous vous contactons suite à votre message concernant: {{ message.sujet }}" 
               class="btn btn-success" target="_blank">
                <i class="fab fa-whatsapp me-1"></i>
                Répondre par WhatsApp
            </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Contenu du message -->
    <div class="col-lg-8 mb-4">
        <div class="table-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-comment me-2"></i>
                    {{ message.sujet }}
                </h5>
                <div>
                    {% if message.is_read %}
                        <span class="badge bg-success">
                            <i class="fas fa-envelope-open me-1"></i>
                            Lu
                        </span>
                    {% else %}
                        <span class="badge bg-warning">
                            <i class="fas fa-envelope me-1"></i>
                            Non lu
                        </span>
                    {% endif %}
                    
                    {% if message.is_replied %}
                        <span class="badge bg-info ms-1">
                            <i class="fas fa-reply me-1"></i>
                            Répondu
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="message-content">
                    {{ message.message|linebreaks }}
                </div>
                
                <hr>
                
                <div class="d-flex justify-content-between align-items-center text-muted">
                    <small>
                        <i class="fas fa-clock me-1"></i>
                        Reçu le {{ message.created_at|date:"d/m/Y à H:i" }}
                    </small>
                    {% if message.is_read %}
                        <small>
                            <i class="fas fa-eye me-1"></i>
                            Message lu
                        </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Informations de l'expéditeur -->
    <div class="col-lg-4 mb-4">
        <div class="table-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2"></i>
                    Informations de l'expéditeur
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 80px; height: 80px;">
                        <i class="fas fa-user fa-2x text-white"></i>
                    </div>
                    <h5>{{ message.nom_prenom }}</h5>
                </div>
                
                <div class="contact-info">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-envelope text-primary me-3" style="width: 20px;"></i>
                        <div>
                            <strong>Email :</strong><br>
                            <a href="mailto:{{ message.email }}" class="text-decoration-none">
                                {{ message.email }}
                            </a>
                        </div>
                    </div>
                    
                    {% if message.telephone %}
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-phone text-primary me-3" style="width: 20px;"></i>
                            <div>
                                <strong>Téléphone :</strong><br>
                                <a href="tel:{{ message.telephone }}" class="text-decoration-none">
                                    {{ message.telephone }}
                                </a>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-calendar text-primary me-3" style="width: 20px;"></i>
                        <div>
                            <strong>Date d'envoi :</strong><br>
                            {{ message.created_at|date:"d/m/Y à H:i" }}
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="d-grid gap-2">
                    <a href="mailto:{{ message.email }}?subject=Re: {{ message.sujet }}" 
                       class="btn btn-primary">
                        <i class="fas fa-reply me-1"></i>
                        Répondre par email
                    </a>
                    
                    {% if message.telephone %}
                        <a href="tel:{{ message.telephone }}" 
                           class="btn btn-outline-success">
                            <i class="fas fa-phone me-1"></i>
                            Appeler
                        </a>
                        <a href="https://wa.me/{{ message.telephone|cut:' '|cut:'+'|cut:'-' }}?text=Bonjour {{ message.nom_prenom }}, nous vous contactons suite à votre message concernant: {{ message.sujet }}" 
                           class="btn btn-success" target="_blank">
                            <i class="fab fa-whatsapp me-1"></i>
                            WhatsApp
                        </a>
                    {% endif %}
                    
                    {% if not message.is_replied %}
                        <a href="{% url 'admin_mark_message_replied' message.pk %}" 
                           class="btn btn-outline-info"
                           onclick="return confirm('Marquer ce message comme répondu ?')">
                            <i class="fas fa-check me-1"></i>
                            Marquer comme répondu
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modèle de réponse -->
<div class="row">
    <div class="col-12">
        <div class="table-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    Modèle de réponse rapide
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Utilisez ce modèle pour répondre rapidement au message. 
                    Cliquez sur le bouton "Copier" puis collez dans votre client email.
                </p>
                
                <div class="bg-light rounded p-3">
                    <div id="emailTemplate">
                        <p><strong>Objet :</strong> Re: {{ message.sujet }}</p>
                        <p><strong>À :</strong> {{ message.email }}</p>
                        <hr>
                        <p>Bonjour {{ message.nom_prenom }},</p>
                        <p>Nous vous remercions pour votre message concernant "{{ message.sujet }}".</p>
                        <p>[Votre réponse ici]</p>
                        <p>Nous restons à votre disposition pour toute question complémentaire.</p>
                        <p>Cordialement,<br>
                        L'équipe A²ELBM2</p>
                    </div>
                </div>
                
                <div class="mt-3 d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="copyEmailTemplate()">
                        <i class="fas fa-copy me-1"></i>
                        Copier le modèle
                    </button>
                    <a href="mailto:{{ message.email }}?subject=Re: {{ message.sujet }}&body=Bonjour {{ message.nom_prenom }},%0D%0A%0D%0ANous vous remercions pour votre message concernant '{{ message.sujet }}'." 
                       class="btn btn-primary">
                        <i class="fas fa-envelope me-1"></i>
                        Ouvrir dans le client email
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="table-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'admin_messages_list' %}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-arrow-left me-1"></i>
                            Retour aux messages
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="mailto:{{ message.email }}?subject=Re: {{ message.sujet }}" 
                           class="btn btn-primary w-100">
                            <i class="fas fa-reply me-1"></i>
                            Répondre
                        </a>
                    </div>
                    {% if not message.is_replied %}
                        <div class="col-md-3 mb-2">
                            <a href="{% url 'admin_mark_message_replied' message.pk %}" 
                               class="btn btn-success w-100"
                               onclick="return confirm('Marquer ce message comme répondu ?')">
                                <i class="fas fa-check me-1"></i>
                                Marquer répondu
                            </a>
                        </div>
                    {% endif %}
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info w-100" onclick="printMessage()">
                            <i class="fas fa-print me-1"></i>
                            Imprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.message-content {
    font-size: 1.1rem;
    line-height: 1.6;
    min-height: 150px;
}

.contact-info .fas {
    opacity: 0.7;
}

@media print {
    .table-card:not(:first-child) {
        display: none;
    }
    
    .btn, .breadcrumb, nav {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function copyEmailTemplate() {
    const template = document.getElementById('emailTemplate').innerText;
    navigator.clipboard.writeText(template).then(function() {
        alert('Modèle copié dans le presse-papiers !');
    });
}

function printMessage() {
    window.print();
}
</script>
{% endblock %}